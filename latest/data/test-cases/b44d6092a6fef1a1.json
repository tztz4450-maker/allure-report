{"uid":"b44d6092a6fef1a1","name":"test_register","fullName":"tests.test_01_register#test_register","historyId":"dbf480063f8c6a444d61a4eced18c7dd","time":{"start":1766456693810,"stop":1766456694857,"duration":1047},"status":"failed","statusMessage":"AssertionError: 接口返回的业务code None 不在允许范围 [200, 40091]内","statusTrace":"raw_client = <utils.api_client.ApiClient object at 0x0000026E4EA98C40>\n\n    def test_register(raw_client):\n        cases = load_yaml(\"data/register.yaml\")\n        env = get_env()\n    \n        for case in cases:\n            with allure.step(case.get(\"desc\", \"注册接口\")):\n    \n                resp = raw_client.request(\n                    method=\"POST\",\n                    url=\"/auth/register\",\n                    params=case[\"request\"].get(\"params\"),\n                    json_body=case[\"request\"]\n                )\n    \n                # ============================\n                # \uD83C\uDF0D prod 环境验证码兜底处理\n                # ============================\n                if env == \"prod\":\n                    biz = resp.biz_json or {}\n                    code = biz.get(\"code\")\n    \n                    if resp.status_code == 400 and code == 40091:\n                        logging.warning(\"⚠ prod 环境注册接口触发验证码，自动 skip\")\n                        pytest.skip(\"prod 环境注册接口有验证码，跳过自动化校验\")\n    \n                # ============================\n                # ✅ 正常断言（pre / 非验证码）\n                # ============================\n>               biz = assert_api_response(resp, case[\"expected\"])\n\ntests\\test_01_register.py:65: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\n\nresp = ApiResponse(response=<Response [200]>, raw_text='{\"x-data\":\"gAAAAABpSf11gE33830NcK4dR8YBzzb9uAnxiYyZ97zmCopk9DDzn_5QmE...-CrnSG9i-rUiiDuy16MmzWBCheyXf4u2dDspx-RzaauPGNPwUacKSuO79SinZ-NrtSh0awcYcRGBk9hOv8yRIpR7uqj7XV154RLOeevtBRL6rWGtNco='})\nexpected = {'allow_biz_codes': [200, 40091], 'allow_http_codes': [200, 400], 'token_prefix': 'Bearer'}\n\n    def assert_api_response(resp, expected):\n        \"\"\"\n        通用接口断言（完全适配 ApiResponse）\n        \"\"\"\n    \n        # ======================\n        # 0️⃣ 响应展示（先做，避免断言失败看不到）\n        # ======================\n        body = _safe_response_body(resp)\n        logging.info(f\"[HTTP] status={getattr(resp, 'status_code', None)}\")\n        # logging.info(f\"[RESP] body={body}\")\n    \n        _attach(\"response_body\", body)\n    \n        # ======================\n        # ① HTTP 状态码校验\n        # ======================\n        allow_http = expected.get(\"allow_http_codes\", [200])\n        if allow_http:\n            assert resp.status_code in allow_http, \\\n                f\"接口返回的HTTP状态码 {resp.status_code} 不在允许范围 {allow_http}内\"\n    \n        # ======================\n        # ② 业务 code 校验\n        # ======================\n        allow_biz = expected.get(\"allow_biz_codes\", [0])\n        if allow_biz:\n            biz_json = resp.biz_json or {}\n            biz_code = _extract_biz_code(biz_json)\n    \n            # 字符串数字 → int\n            try:\n                if isinstance(biz_code, str) and biz_code.isdigit():\n                    biz_code = int(biz_code)\n            except Exception:\n                pass\n    \n            logging.info(f\"[实际返回] code={biz_code}, [断言] code={allow_biz}\")\n    \n            try:\n>               assert biz_code in allow_biz, \\\n                    f\"接口返回的业务code {biz_code} 不在允许范围 {allow_biz}内\"\nE                   AssertionError: 接口返回的业务code None 不在允许范围 [200, 40091]内\n\nutils\\assert_util.py:91: AssertionError","flaky":false,"newFailed":false,"newBroken":false,"newPassed":false,"retriesCount":0,"retriesStatusChange":false,"beforeStages":[{"name":"raw_client","time":{"start":1766456693810,"stop":1766456693810,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"attachmentStep":false,"attachmentsCount":0,"stepsCount":0,"hasContent":false},{"name":"pytestconfig","time":{"start":1766456693810,"stop":1766456693810,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"attachmentStep":false,"attachmentsCount":0,"stepsCount":0,"hasContent":false}],"testStage":{"status":"failed","statusMessage":"AssertionError: 接口返回的业务code None 不在允许范围 [200, 40091]内","statusTrace":"raw_client = <utils.api_client.ApiClient object at 0x0000026E4EA98C40>\n\n    def test_register(raw_client):\n        cases = load_yaml(\"data/register.yaml\")\n        env = get_env()\n    \n        for case in cases:\n            with allure.step(case.get(\"desc\", \"注册接口\")):\n    \n                resp = raw_client.request(\n                    method=\"POST\",\n                    url=\"/auth/register\",\n                    params=case[\"request\"].get(\"params\"),\n                    json_body=case[\"request\"]\n                )\n    \n                # ============================\n                # \uD83C\uDF0D prod 环境验证码兜底处理\n                # ============================\n                if env == \"prod\":\n                    biz = resp.biz_json or {}\n                    code = biz.get(\"code\")\n    \n                    if resp.status_code == 400 and code == 40091:\n                        logging.warning(\"⚠ prod 环境注册接口触发验证码，自动 skip\")\n                        pytest.skip(\"prod 环境注册接口有验证码，跳过自动化校验\")\n    \n                # ============================\n                # ✅ 正常断言（pre / 非验证码）\n                # ============================\n>               biz = assert_api_response(resp, case[\"expected\"])\n\ntests\\test_01_register.py:65: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\n\nresp = ApiResponse(response=<Response [200]>, raw_text='{\"x-data\":\"gAAAAABpSf11gE33830NcK4dR8YBzzb9uAnxiYyZ97zmCopk9DDzn_5QmE...-CrnSG9i-rUiiDuy16MmzWBCheyXf4u2dDspx-RzaauPGNPwUacKSuO79SinZ-NrtSh0awcYcRGBk9hOv8yRIpR7uqj7XV154RLOeevtBRL6rWGtNco='})\nexpected = {'allow_biz_codes': [200, 40091], 'allow_http_codes': [200, 400], 'token_prefix': 'Bearer'}\n\n    def assert_api_response(resp, expected):\n        \"\"\"\n        通用接口断言（完全适配 ApiResponse）\n        \"\"\"\n    \n        # ======================\n        # 0️⃣ 响应展示（先做，避免断言失败看不到）\n        # ======================\n        body = _safe_response_body(resp)\n        logging.info(f\"[HTTP] status={getattr(resp, 'status_code', None)}\")\n        # logging.info(f\"[RESP] body={body}\")\n    \n        _attach(\"response_body\", body)\n    \n        # ======================\n        # ① HTTP 状态码校验\n        # ======================\n        allow_http = expected.get(\"allow_http_codes\", [200])\n        if allow_http:\n            assert resp.status_code in allow_http, \\\n                f\"接口返回的HTTP状态码 {resp.status_code} 不在允许范围 {allow_http}内\"\n    \n        # ======================\n        # ② 业务 code 校验\n        # ======================\n        allow_biz = expected.get(\"allow_biz_codes\", [0])\n        if allow_biz:\n            biz_json = resp.biz_json or {}\n            biz_code = _extract_biz_code(biz_json)\n    \n            # 字符串数字 → int\n            try:\n                if isinstance(biz_code, str) and biz_code.isdigit():\n                    biz_code = int(biz_code)\n            except Exception:\n                pass\n    \n            logging.info(f\"[实际返回] code={biz_code}, [断言] code={allow_biz}\")\n    \n            try:\n>               assert biz_code in allow_biz, \\\n                    f\"接口返回的业务code {biz_code} 不在允许范围 {allow_biz}内\"\nE                   AssertionError: 接口返回的业务code None 不在允许范围 [200, 40091]内\n\nutils\\assert_util.py:91: AssertionError","steps":[{"name":"正常注册","time":{"start":1766456693825,"stop":1766456694857,"duration":1032},"status":"failed","statusMessage":"AssertionError: 接口返回的业务code None 不在允许范围 [200, 40091]内\n","statusTrace":"  File \"D:\\PycharmProjects\\23pg-api-test\\tests\\test_01_register.py\", line 65, in test_register\n    biz = assert_api_response(resp, case[\"expected\"])\n  File \"D:\\PycharmProjects\\23pg-api-test\\utils\\assert_util.py\", line 91, in assert_api_response\n    assert biz_code in allow_biz, \\\n","steps":[],"attachments":[{"uid":"4ed55241b4aa0144","name":"response_body","source":"4ed55241b4aa0144.json","type":"application/json","size":650},{"uid":"b2301b2b6b4c0043","name":"assert_fail_response","source":"b2301b2b6b4c0043.json","type":"application/json","size":650}],"parameters":[],"shouldDisplayMessage":true,"attachmentStep":false,"attachmentsCount":2,"stepsCount":0,"hasContent":true}],"attachments":[{"uid":"3ff3232bfcb92dd7","name":"log","source":"3ff3232bfcb92dd7.txt","type":"text/plain","size":1798}],"parameters":[],"shouldDisplayMessage":true,"attachmentStep":false,"attachmentsCount":3,"stepsCount":1,"hasContent":true},"afterStages":[],"labels":[{"name":"parentSuite","value":"tests"},{"name":"suite","value":"test_01_register"},{"name":"host","value":"DESKTOP-1OGQ5RE"},{"name":"thread","value":"24592-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"tests.test_01_register"},{"name":"resultFormat","value":"allure2"}],"parameters":[],"links":[],"hidden":false,"retry":false,"extra":{"severity":"normal","retries":[],"categories":[{"name":"Product defects","matchedStatuses":[]}],"tags":[]},"source":"b44d6092a6fef1a1.json","parameterValues":[]}