{"uid":"aa238defacee1121","name":"test_user_security[/api/cards/card_create-case5]","fullName":"tests.test_03_user_security#test_user_security","historyId":"1d537ea3be86a958fbdede55eb0cfc48","time":{"start":1766458591485,"stop":1766458592084,"duration":599},"status":"failed","statusMessage":"AssertionError: 接口返回的业务code 40050 不在允许范围 [40001]内","statusTrace":"auth_client = <utils.api_client.ApiClient object at 0x0000029BE6A06860>, case_name = '/api/cards/card_create'\ncase = {'desc': '取款账户_银行卡', 'expected': {'allow_biz_codes': [40001], 'allow_http_codes': [400]}, 'request': {'body': {'accoun... 'POST', 'params': {'force_no_encrypt': '567f9c9a-28cf-4096-b540-e428f40a1e74-jh82'}, 'url': '/api/cards/card_create'}}\n\n    @pytest.mark.parametrize(\"case_name, case\", yaml_data.items())\n    @allure.feature(\"用户安全模块\")\n    def test_user_security(auth_client, case_name, case):\n    \n        # 用例标题显示接口名称，而不是 desc\n        with allure.step(case_name):\n    \n            resp = auth_client.request(\n                method=case[\"request\"][\"method\"],\n                url=case[\"request\"][\"url\"],\n                params=case[\"request\"].get(\"params\"),\n                json_body=case[\"request\"].get(\"body\"),\n            )\n    \n            # 核心断言\n>           biz = assert_api_response(resp, case[\"expected\"])\n\ntests\\test_03_user_security.py:26: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\n\nresp = ApiResponse(response=<Response [400]>, raw_text='{\"code\":40050,\"message\":\"需要验证手机\"}', json_data={'code': 40050, 'message': '需要验证手机'}, biz_json={'code': 40050, 'message': '需要验证手机'})\nexpected = {'allow_biz_codes': [40001], 'allow_http_codes': [400]}\n\n    def assert_api_response(resp, expected):\n        \"\"\"\n        通用接口断言（完全适配 ApiResponse）\n        \"\"\"\n    \n        # ======================\n        # 0️⃣ 响应展示（先做，避免断言失败看不到）\n        # ======================\n        body = _safe_response_body(resp)\n        logging.info(f\"[HTTP] status={getattr(resp, 'status_code', None)}\")\n        # logging.info(f\"[RESP] body={body}\")\n    \n        _attach(\"response_body\", body)\n    \n        # ======================\n        # ① HTTP 状态码校验\n        # ======================\n        allow_http = expected.get(\"allow_http_codes\", [200])\n        if allow_http:\n            assert resp.status_code in allow_http, \\\n                f\"接口返回的HTTP状态码 {resp.status_code} 不在允许范围 {allow_http}内\"\n    \n        # ======================\n        # ② 业务 code 校验\n        # ======================\n        allow_biz = expected.get(\"allow_biz_codes\", [0])\n        if allow_biz:\n            biz_json = resp.biz_json or {}\n            biz_code = _extract_biz_code(biz_json)\n    \n            # 字符串数字 → int\n            try:\n                if isinstance(biz_code, str) and biz_code.isdigit():\n                    biz_code = int(biz_code)\n            except Exception:\n                pass\n    \n            logging.info(f\"[实际返回] code={biz_code}, [断言] code={allow_biz}\")\n    \n            try:\n>               assert biz_code in allow_biz, \\\n                    f\"接口返回的业务code {biz_code} 不在允许范围 {allow_biz}内\"\nE                   AssertionError: 接口返回的业务code 40050 不在允许范围 [40001]内\n\nutils\\assert_util.py:91: AssertionError","flaky":false,"newFailed":false,"newBroken":false,"newPassed":false,"retriesCount":0,"retriesStatusChange":false,"beforeStages":[{"name":"pytestconfig","time":{"start":1766458581540,"stop":1766458581540,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"hasContent":false,"attachmentStep":false,"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0},{"name":"raw_client","time":{"start":1766458581540,"stop":1766458581540,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"hasContent":false,"attachmentStep":false,"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0},{"name":"auth_client","time":{"start":1766458582038,"stop":1766458582985,"duration":947},"status":"passed","steps":[],"attachments":[],"parameters":[],"hasContent":false,"attachmentStep":false,"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0}],"testStage":{"status":"failed","statusMessage":"AssertionError: 接口返回的业务code 40050 不在允许范围 [40001]内","statusTrace":"auth_client = <utils.api_client.ApiClient object at 0x0000029BE6A06860>, case_name = '/api/cards/card_create'\ncase = {'desc': '取款账户_银行卡', 'expected': {'allow_biz_codes': [40001], 'allow_http_codes': [400]}, 'request': {'body': {'accoun... 'POST', 'params': {'force_no_encrypt': '567f9c9a-28cf-4096-b540-e428f40a1e74-jh82'}, 'url': '/api/cards/card_create'}}\n\n    @pytest.mark.parametrize(\"case_name, case\", yaml_data.items())\n    @allure.feature(\"用户安全模块\")\n    def test_user_security(auth_client, case_name, case):\n    \n        # 用例标题显示接口名称，而不是 desc\n        with allure.step(case_name):\n    \n            resp = auth_client.request(\n                method=case[\"request\"][\"method\"],\n                url=case[\"request\"][\"url\"],\n                params=case[\"request\"].get(\"params\"),\n                json_body=case[\"request\"].get(\"body\"),\n            )\n    \n            # 核心断言\n>           biz = assert_api_response(resp, case[\"expected\"])\n\ntests\\test_03_user_security.py:26: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\n\nresp = ApiResponse(response=<Response [400]>, raw_text='{\"code\":40050,\"message\":\"需要验证手机\"}', json_data={'code': 40050, 'message': '需要验证手机'}, biz_json={'code': 40050, 'message': '需要验证手机'})\nexpected = {'allow_biz_codes': [40001], 'allow_http_codes': [400]}\n\n    def assert_api_response(resp, expected):\n        \"\"\"\n        通用接口断言（完全适配 ApiResponse）\n        \"\"\"\n    \n        # ======================\n        # 0️⃣ 响应展示（先做，避免断言失败看不到）\n        # ======================\n        body = _safe_response_body(resp)\n        logging.info(f\"[HTTP] status={getattr(resp, 'status_code', None)}\")\n        # logging.info(f\"[RESP] body={body}\")\n    \n        _attach(\"response_body\", body)\n    \n        # ======================\n        # ① HTTP 状态码校验\n        # ======================\n        allow_http = expected.get(\"allow_http_codes\", [200])\n        if allow_http:\n            assert resp.status_code in allow_http, \\\n                f\"接口返回的HTTP状态码 {resp.status_code} 不在允许范围 {allow_http}内\"\n    \n        # ======================\n        # ② 业务 code 校验\n        # ======================\n        allow_biz = expected.get(\"allow_biz_codes\", [0])\n        if allow_biz:\n            biz_json = resp.biz_json or {}\n            biz_code = _extract_biz_code(biz_json)\n    \n            # 字符串数字 → int\n            try:\n                if isinstance(biz_code, str) and biz_code.isdigit():\n                    biz_code = int(biz_code)\n            except Exception:\n                pass\n    \n            logging.info(f\"[实际返回] code={biz_code}, [断言] code={allow_biz}\")\n    \n            try:\n>               assert biz_code in allow_biz, \\\n                    f\"接口返回的业务code {biz_code} 不在允许范围 {allow_biz}内\"\nE                   AssertionError: 接口返回的业务code 40050 不在允许范围 [40001]内\n\nutils\\assert_util.py:91: AssertionError","steps":[{"name":"/api/cards/card_create","time":{"start":1766458591485,"stop":1766458592084,"duration":599},"status":"failed","statusMessage":"AssertionError: 接口返回的业务code 40050 不在允许范围 [40001]内\n","statusTrace":"  File \"D:\\PycharmProjects\\23pg-api-test\\tests\\test_03_user_security.py\", line 26, in test_user_security\n    biz = assert_api_response(resp, case[\"expected\"])\n  File \"D:\\PycharmProjects\\23pg-api-test\\utils\\assert_util.py\", line 91, in assert_api_response\n    assert biz_code in allow_biz, \\\n","steps":[],"attachments":[{"uid":"1dfcc0355af364c0","name":"response_body","source":"1dfcc0355af364c0.json","type":"application/json","size":54},{"uid":"ec4bda48581da07b","name":"assert_fail_response","source":"ec4bda48581da07b.json","type":"application/json","size":54}],"parameters":[],"hasContent":true,"attachmentStep":false,"shouldDisplayMessage":true,"stepsCount":0,"attachmentsCount":2}],"attachments":[{"uid":"8d99f3c0a1fbd050","name":"log","source":"8d99f3c0a1fbd050.txt","type":"text/plain","size":1374}],"parameters":[],"hasContent":true,"attachmentStep":false,"shouldDisplayMessage":true,"stepsCount":1,"attachmentsCount":3},"afterStages":[],"labels":[{"name":"feature","value":"用户安全模块"},{"name":"parentSuite","value":"tests"},{"name":"suite","value":"test_03_user_security"},{"name":"host","value":"DESKTOP-1OGQ5RE"},{"name":"thread","value":"26644-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"tests.test_03_user_security"},{"name":"resultFormat","value":"allure2"}],"parameters":[{"name":"case","value":"{'desc': '取款账户_银行卡', 'request': {'method': 'POST', 'url': '/api/cards/card_create', 'params': {'force_no_encrypt': '567f9c9a-28cf-4096-b540-e428f40a1e74-jh82'}, 'body': {'type': 'bank', 'account': '6225889290705369', 'open_bank': '招商银行', 'sub_bank': '支行', 'default': True, 'real_name': '王哈', 'wp_password': '123456', 'email': 'tztz4450@gmail.com', 'verify_code': '123456'}}, 'expected': {'allow_http_codes': [400], 'allow_biz_codes': [40001]}}"},{"name":"case_name","value":"'/api/cards/card_create'"}],"links":[],"hidden":false,"retry":false,"extra":{"severity":"normal","retries":[],"categories":[{"name":"Product defects","matchedStatuses":[]}],"tags":[]},"source":"aa238defacee1121.json","parameterValues":["{'desc': '取款账户_银行卡', 'request': {'method': 'POST', 'url': '/api/cards/card_create', 'params': {'force_no_encrypt': '567f9c9a-28cf-4096-b540-e428f40a1e74-jh82'}, 'body': {'type': 'bank', 'account': '6225889290705369', 'open_bank': '招商银行', 'sub_bank': '支行', 'default': True, 'real_name': '王哈', 'wp_password': '123456', 'email': 'tztz4450@gmail.com', 'verify_code': '123456'}}, 'expected': {'allow_http_codes': [400], 'allow_biz_codes': [40001]}}","'/api/cards/card_create'"]}