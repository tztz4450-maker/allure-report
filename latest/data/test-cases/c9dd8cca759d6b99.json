{"uid":"c9dd8cca759d6b99","name":"test_finance_center[/bets/query/-case6]","fullName":"tests.test_06_finance_center#test_finance_center","historyId":"3b533eeaeb7553f126d446aee14aedd6","time":{"start":1766489425813,"stop":1766489426166,"duration":353},"status":"failed","statusMessage":"AssertionError: 接口未返回业务code，HTTP=404","statusTrace":"auth_client = <utils.api_client.ApiClient object at 0x000001D47075E710>\ncase_name = '/bets/query/'\ncase = {'desc': '投注记录', 'expected': {'allow_biz_codes': [0], 'allow_http_codes': [200]}, 'request': {'method': 'GET', 'params... 'force_no_encrypt': '567f9c9a-28cf-4096-b540-e428f40a1e74-jh82', 'limit': 10, 'page': 1, ...}, 'url': '/bets/query/'}}\ncase_vars = <function replace_vars at 0x000001D46FE1AF80>\n\n    @pytest.mark.parametrize(\"case_name, case\", yaml_data.items())\n    @allure.feature(\"账务中心\")\n    def test_finance_center(auth_client, case_name, case,case_vars):\n    \n        from utils.variables import replace_vars\n        case = replace_vars(case)\n    \n        # 用例标题显示接口名称，而不是 desc\n        with allure.step(case_name):\n    \n            resp = auth_client.request(\n                method=case[\"request\"][\"method\"],\n                url=case[\"request\"][\"url\"],\n                params=case[\"request\"].get(\"params\"),\n                json_body=case[\"request\"].get(\"body\"),\n            )\n    \n            # 核心断言\n>           biz = assert_api_response(resp, case[\"expected\"])\n\ntests\\test_06_finance_center.py:29: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\n\nresp = ApiResponse(response=<Response [404]>, raw_text='{\"detail\":\"Not Found\"}', json_data={'detail': 'Not Found'}, biz_json={'detail': 'Not Found'})\nexpected = {'allow_biz_codes': [0], 'allow_http_codes': [200]}\n\n    def assert_api_response(resp, expected):\n        \"\"\"\n        通用接口断言（最终稳定版）\n        - 以「业务 code」为主\n        - HTTP 状态码只作为兜底\n        - 语义清晰，TG / Allure 友好\n        \"\"\"\n    \n        # =====================================================\n        # 0️⃣ 基础响应信息（永远先记录，防止断言中断）\n        # =====================================================\n        body = _safe_response_body(resp)\n    \n        http_status = getattr(resp, \"status_code\", None)\n        logging.info(f\"[HTTP] status={http_status}\")\n    \n        _attach(\"response_body\", body)\n    \n        biz_json = resp.biz_json or {}\n    \n        # =====================================================\n        # 1️⃣ 业务 code 校验（核心）\n        # =====================================================\n        allow_biz = expected.get(\"allow_biz_codes\")\n    \n        # \uD83D\uDC49 只有在 allow_biz 为「非空列表」时才校验\n        if isinstance(allow_biz, list) and len(allow_biz) > 0:\n            biz_json = resp.biz_json or {}\n            biz_code = _extract_biz_code(biz_json)\n    \n            # 兼容字符串数字\n            if isinstance(biz_code, str) and biz_code.isdigit():\n                biz_code = int(biz_code)\n    \n            logging.info(\n                \"[业务断言] 实际 code=%s | 允许=%s\",\n                biz_code,\n                allow_biz\n            )\n    \n            # 提取 msg（兼容多种字段名）\n            biz_msg = (\n                    biz_json.get(\"msg\")\n                    or biz_json.get(\"message\")\n                    or biz_json.get(\"errorMsg\")\n            )\n            msg_suffix = f\"，msg={biz_msg}\" if biz_msg else \"\"\n    \n            # \uD83D\uDEAB 要求业务 code，但接口没返回\n            if biz_code is None:\n                _attach(\"assert_fail_response\", biz_json)\n>               raise AssertionError(\n                    f\"接口未返回业务code\"\n                    f\"，HTTP={resp.status_code}\"\n                    f\"{msg_suffix}\"\n                )\nE               AssertionError: 接口未返回业务code，HTTP=404\n\nutils\\assert_util.py:102: AssertionError","flaky":false,"newFailed":false,"newBroken":false,"newPassed":false,"retriesCount":1,"retriesStatusChange":false,"beforeStages":[{"name":"raw_client","time":{"start":1766489401018,"stop":1766489401023,"duration":5},"status":"passed","steps":[],"attachments":[],"parameters":[],"hasContent":false,"shouldDisplayMessage":false,"stepsCount":0,"attachmentStep":false,"attachmentsCount":0},{"name":"pytestconfig","time":{"start":1766489401018,"stop":1766489401018,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"hasContent":false,"shouldDisplayMessage":false,"stepsCount":0,"attachmentStep":false,"attachmentsCount":0},{"name":"auth_client","time":{"start":1766489401023,"stop":1766489402082,"duration":1059},"status":"passed","steps":[],"attachments":[],"parameters":[],"hasContent":false,"shouldDisplayMessage":false,"stepsCount":0,"attachmentStep":false,"attachmentsCount":0},{"name":"case_vars","time":{"start":1766489425812,"stop":1766489425812,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"hasContent":false,"shouldDisplayMessage":false,"stepsCount":0,"attachmentStep":false,"attachmentsCount":0},{"name":"auth_guard","time":{"start":1766489425812,"stop":1766489425812,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"hasContent":false,"shouldDisplayMessage":false,"stepsCount":0,"attachmentStep":false,"attachmentsCount":0}],"testStage":{"status":"failed","statusMessage":"AssertionError: 接口未返回业务code，HTTP=404","statusTrace":"auth_client = <utils.api_client.ApiClient object at 0x000001D47075E710>\ncase_name = '/bets/query/'\ncase = {'desc': '投注记录', 'expected': {'allow_biz_codes': [0], 'allow_http_codes': [200]}, 'request': {'method': 'GET', 'params... 'force_no_encrypt': '567f9c9a-28cf-4096-b540-e428f40a1e74-jh82', 'limit': 10, 'page': 1, ...}, 'url': '/bets/query/'}}\ncase_vars = <function replace_vars at 0x000001D46FE1AF80>\n\n    @pytest.mark.parametrize(\"case_name, case\", yaml_data.items())\n    @allure.feature(\"账务中心\")\n    def test_finance_center(auth_client, case_name, case,case_vars):\n    \n        from utils.variables import replace_vars\n        case = replace_vars(case)\n    \n        # 用例标题显示接口名称，而不是 desc\n        with allure.step(case_name):\n    \n            resp = auth_client.request(\n                method=case[\"request\"][\"method\"],\n                url=case[\"request\"][\"url\"],\n                params=case[\"request\"].get(\"params\"),\n                json_body=case[\"request\"].get(\"body\"),\n            )\n    \n            # 核心断言\n>           biz = assert_api_response(resp, case[\"expected\"])\n\ntests\\test_06_finance_center.py:29: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\n\nresp = ApiResponse(response=<Response [404]>, raw_text='{\"detail\":\"Not Found\"}', json_data={'detail': 'Not Found'}, biz_json={'detail': 'Not Found'})\nexpected = {'allow_biz_codes': [0], 'allow_http_codes': [200]}\n\n    def assert_api_response(resp, expected):\n        \"\"\"\n        通用接口断言（最终稳定版）\n        - 以「业务 code」为主\n        - HTTP 状态码只作为兜底\n        - 语义清晰，TG / Allure 友好\n        \"\"\"\n    \n        # =====================================================\n        # 0️⃣ 基础响应信息（永远先记录，防止断言中断）\n        # =====================================================\n        body = _safe_response_body(resp)\n    \n        http_status = getattr(resp, \"status_code\", None)\n        logging.info(f\"[HTTP] status={http_status}\")\n    \n        _attach(\"response_body\", body)\n    \n        biz_json = resp.biz_json or {}\n    \n        # =====================================================\n        # 1️⃣ 业务 code 校验（核心）\n        # =====================================================\n        allow_biz = expected.get(\"allow_biz_codes\")\n    \n        # \uD83D\uDC49 只有在 allow_biz 为「非空列表」时才校验\n        if isinstance(allow_biz, list) and len(allow_biz) > 0:\n            biz_json = resp.biz_json or {}\n            biz_code = _extract_biz_code(biz_json)\n    \n            # 兼容字符串数字\n            if isinstance(biz_code, str) and biz_code.isdigit():\n                biz_code = int(biz_code)\n    \n            logging.info(\n                \"[业务断言] 实际 code=%s | 允许=%s\",\n                biz_code,\n                allow_biz\n            )\n    \n            # 提取 msg（兼容多种字段名）\n            biz_msg = (\n                    biz_json.get(\"msg\")\n                    or biz_json.get(\"message\")\n                    or biz_json.get(\"errorMsg\")\n            )\n            msg_suffix = f\"，msg={biz_msg}\" if biz_msg else \"\"\n    \n            # \uD83D\uDEAB 要求业务 code，但接口没返回\n            if biz_code is None:\n                _attach(\"assert_fail_response\", biz_json)\n>               raise AssertionError(\n                    f\"接口未返回业务code\"\n                    f\"，HTTP={resp.status_code}\"\n                    f\"{msg_suffix}\"\n                )\nE               AssertionError: 接口未返回业务code，HTTP=404\n\nutils\\assert_util.py:102: AssertionError","steps":[{"name":"/bets/query/","time":{"start":1766489425813,"stop":1766489426165,"duration":352},"status":"failed","statusMessage":"AssertionError: 接口未返回业务code，HTTP=404\n","statusTrace":"  File \"D:\\PycharmProjects\\23pg-api-test\\tests\\test_06_finance_center.py\", line 29, in test_finance_center\n    biz = assert_api_response(resp, case[\"expected\"])\n  File \"D:\\PycharmProjects\\23pg-api-test\\utils\\assert_util.py\", line 102, in assert_api_response\n    raise AssertionError(\n","steps":[],"attachments":[{"uid":"c79b55bf3d2a435","name":"response_body","source":"c79b55bf3d2a435.json","type":"application/json","size":27},{"uid":"5d1f09f9f978bff1","name":"assert_fail_response","source":"5d1f09f9f978bff1.json","type":"application/json","size":27}],"parameters":[],"hasContent":true,"shouldDisplayMessage":true,"stepsCount":0,"attachmentStep":false,"attachmentsCount":2}],"attachments":[{"uid":"f5dac3667c6a397b","name":"log","source":"f5dac3667c6a397b.txt","type":"text/plain","size":2137}],"parameters":[],"hasContent":true,"shouldDisplayMessage":true,"stepsCount":1,"attachmentStep":false,"attachmentsCount":3},"afterStages":[],"labels":[{"name":"feature","value":"账务中心"},{"name":"parentSuite","value":"tests"},{"name":"suite","value":"test_06_finance_center"},{"name":"host","value":"DESKTOP-1OGQ5RE"},{"name":"thread","value":"8692-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"tests.test_06_finance_center"},{"name":"resultFormat","value":"allure2"}],"parameters":[{"name":"case","value":"{'desc': '投注记录', 'request': {'method': 'GET', 'url': '/bets/query/', 'params': {'page': 1, 'limit': 10, 'force_no_encrypt': '567f9c9a-28cf-4096-b540-e428f40a1e74-jh82', 'user_id': '${USER_ID}', 'date': '${TODAY_NOSEP}'}}, 'expected': {'allow_http_codes': [200], 'allow_biz_codes': [0]}}"},{"name":"case_name","value":"'/bets/query/'"}],"links":[],"hidden":false,"retry":false,"extra":{"severity":"normal","retries":[{"uid":"a4d351e2cb0de8fc","status":"failed","statusDetails":"AssertionError: 接口未返回业务code，HTTP=404","time":{"start":1766489423384,"stop":1766489423795,"duration":411}}],"categories":[{"name":"Product defects","matchedStatuses":[]}],"tags":[]},"source":"c9dd8cca759d6b99.json","parameterValues":["{'desc': '投注记录', 'request': {'method': 'GET', 'url': '/bets/query/', 'params': {'page': 1, 'limit': 10, 'force_no_encrypt': '567f9c9a-28cf-4096-b540-e428f40a1e74-jh82', 'user_id': '${USER_ID}', 'date': '${TODAY_NOSEP}'}}, 'expected': {'allow_http_codes': [200], 'allow_biz_codes': [0]}}","'/bets/query/'"]}