{"uid":"7e08de8ea3ce86b0","name":"test_games[/game/games/l_cl-case5]","fullName":"tests.test_08_games#test_games","historyId":"612c4cdc02cdbdb6ea5bde3e65d59160","time":{"start":1766564746896,"stop":1766564748945,"duration":2049},"status":"failed","statusMessage":"AssertionError: 接口返回的业务code 200 不在允许范围 [2000] 内","statusTrace":"auth_client = <utils.api_client.ApiClient object at 0x00000263FD513610>, case_name = '/game/games/l_cl'\ncase = {'desc': '查询长龙链接', 'expected': {'allow_biz_codes': [2000], 'allow_http_codes': [200]}, 'request': {'body': {'code': 'l...h': '$.data.url'}, 'method': 'POST', 'params': {'force_no_encrypt': '567f9c9a-28cf-4096-b540-e428f40a1e74-jh82'}, ...}}\ncase_vars = <function replace_vars at 0x00000263FD4792D0>, check_extra_url = <function check_extra_url.<locals>._check at 0x00000263FD58F010>\n\n    @pytest.mark.smoke\n    @pytest.mark.parametrize(\"case_name, case\", yaml_data.items())\n    @allure.feature(\"游戏模块\")\n    \n    def test_games(auth_client, case_name, case, case_vars, check_extra_url):\n    \n        # case = case_vars(case)\n        case[\"request\"] = case_vars(case[\"request\"])\n    \n        with allure.step(case_name):\n    \n            resp = auth_client.request(\n                method=case[\"request\"][\"method\"],\n                url=case[\"request\"][\"url\"],\n                params=case[\"request\"].get(\"params\"),\n                json_body=case[\"request\"].get(\"body\"),\n            )\n    \n            # 仅检测 /game/games/l 的跳转链接\n            if case[\"request\"][\"url\"] == \"/game/games/l\":\n    \n                jp = parse(case[\"request\"][\"check_url_from\"][\"jsonpath\"])\n                matches = jp.find(resp.json_data)\n    \n                if not matches:\n                    raise AssertionError(\"未找到跳转 URL\")\n    \n                url = matches[0].value\n                check_extra_url(url)\n    \n            # 核心断言\n>           biz = assert_api_response(resp, case[\"expected\"])\n\ntests\\test_08_games.py:40: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\n\nresp = ApiResponse(response=<Response [200]>, raw_text='{\"data\":{\"url\":\"https://lott.v6a7hash.com/longDragon?token=eyJhbGciOi...JQ&back_url=extra.dm', 'platform': 'V6Lottery', 'game': 'longDragon', 'method': 'get', 'redirect': True}, 'code': 200})\nexpected = {'allow_biz_codes': [2000], 'allow_http_codes': [200]}\n\n    def assert_api_response(resp, expected):\n        \"\"\"\n        通用接口断言（最终稳定版）\n        - 以「业务 code」为主\n        - HTTP 状态码只作为兜底\n        - 语义清晰，TG / Allure 友好\n        \"\"\"\n    \n        # =====================================================\n        # 0️⃣ 基础响应信息（永远先记录，防止断言中断）\n        # =====================================================\n        body = _safe_response_body(resp)\n    \n        http_status = getattr(resp, \"status_code\", None)\n        logging.info(f\"[HTTP] status={http_status}\")\n    \n        _attach(\"response_body\", body)\n    \n        biz_json = resp.biz_json or {}\n    \n        # =====================================================\n        # 1️⃣ 业务 code 校验（核心）\n        # =====================================================\n        allow_biz = expected.get(\"allow_biz_codes\")\n    \n        # \uD83D\uDC49 只有在 allow_biz 为「非空列表」时才校验\n        if isinstance(allow_biz, list) and len(allow_biz) > 0:\n            biz_json = resp.biz_json or {}\n            biz_code = _extract_biz_code(biz_json)\n    \n            # 兼容字符串数字\n            if isinstance(biz_code, str) and biz_code.isdigit():\n                biz_code = int(biz_code)\n    \n            logging.info(\n                \"[业务断言] 实际 code=%s | 允许=%s\",\n                biz_code,\n                allow_biz\n            )\n    \n            # 提取 msg（兼容多种字段名）\n            biz_msg = (\n                    biz_json.get(\"msg\")\n                    or biz_json.get(\"message\")\n                    or biz_json.get(\"errorMsg\")\n            )\n            msg_suffix = f\"，msg={biz_msg}\" if biz_msg else \"\"\n    \n            # \uD83D\uDEAB 要求业务 code，但接口没返回\n            if biz_code is None:\n                _attach(\"assert_fail_response\", biz_json)\n                raise AssertionError(\n                    f\"接口未返回业务code\"\n                    f\"，HTTP={resp.status_code}\"\n                    f\"{msg_suffix}\"\n                )\n    \n            try:\n>               assert biz_code in allow_biz, (\n                    f\"接口返回的业务code {biz_code} \"\n                    f\"不在允许范围 {allow_biz} 内\"\n                    f\"{msg_suffix}\"\n                )\nE               AssertionError: 接口返回的业务code 200 不在允许范围 [2000] 内\n\nutils\\assert_util.py:109: AssertionError","flaky":false,"newFailed":false,"newBroken":false,"newPassed":false,"retriesCount":0,"retriesStatusChange":false,"beforeStages":[{"name":"pytestconfig","time":{"start":1766564702466,"stop":1766564702466,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"attachmentsCount":0,"shouldDisplayMessage":false,"attachmentStep":false,"hasContent":false},{"name":"raw_client","time":{"start":1766564702466,"stop":1766564702466,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"attachmentsCount":0,"shouldDisplayMessage":false,"attachmentStep":false,"hasContent":false},{"name":"auth_client","time":{"start":1766564702466,"stop":1766564706791,"duration":4325},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"attachmentsCount":0,"shouldDisplayMessage":false,"attachmentStep":false,"hasContent":false},{"name":"check_extra_url","time":{"start":1766564746896,"stop":1766564746896,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"attachmentsCount":0,"shouldDisplayMessage":false,"attachmentStep":false,"hasContent":false},{"name":"case_vars","time":{"start":1766564746896,"stop":1766564746896,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"attachmentsCount":0,"shouldDisplayMessage":false,"attachmentStep":false,"hasContent":false},{"name":"auth_guard","time":{"start":1766564746896,"stop":1766564746896,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"attachmentsCount":0,"shouldDisplayMessage":false,"attachmentStep":false,"hasContent":false}],"testStage":{"status":"failed","statusMessage":"AssertionError: 接口返回的业务code 200 不在允许范围 [2000] 内","statusTrace":"auth_client = <utils.api_client.ApiClient object at 0x00000263FD513610>, case_name = '/game/games/l_cl'\ncase = {'desc': '查询长龙链接', 'expected': {'allow_biz_codes': [2000], 'allow_http_codes': [200]}, 'request': {'body': {'code': 'l...h': '$.data.url'}, 'method': 'POST', 'params': {'force_no_encrypt': '567f9c9a-28cf-4096-b540-e428f40a1e74-jh82'}, ...}}\ncase_vars = <function replace_vars at 0x00000263FD4792D0>, check_extra_url = <function check_extra_url.<locals>._check at 0x00000263FD58F010>\n\n    @pytest.mark.smoke\n    @pytest.mark.parametrize(\"case_name, case\", yaml_data.items())\n    @allure.feature(\"游戏模块\")\n    \n    def test_games(auth_client, case_name, case, case_vars, check_extra_url):\n    \n        # case = case_vars(case)\n        case[\"request\"] = case_vars(case[\"request\"])\n    \n        with allure.step(case_name):\n    \n            resp = auth_client.request(\n                method=case[\"request\"][\"method\"],\n                url=case[\"request\"][\"url\"],\n                params=case[\"request\"].get(\"params\"),\n                json_body=case[\"request\"].get(\"body\"),\n            )\n    \n            # 仅检测 /game/games/l 的跳转链接\n            if case[\"request\"][\"url\"] == \"/game/games/l\":\n    \n                jp = parse(case[\"request\"][\"check_url_from\"][\"jsonpath\"])\n                matches = jp.find(resp.json_data)\n    \n                if not matches:\n                    raise AssertionError(\"未找到跳转 URL\")\n    \n                url = matches[0].value\n                check_extra_url(url)\n    \n            # 核心断言\n>           biz = assert_api_response(resp, case[\"expected\"])\n\ntests\\test_08_games.py:40: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\n\nresp = ApiResponse(response=<Response [200]>, raw_text='{\"data\":{\"url\":\"https://lott.v6a7hash.com/longDragon?token=eyJhbGciOi...JQ&back_url=extra.dm', 'platform': 'V6Lottery', 'game': 'longDragon', 'method': 'get', 'redirect': True}, 'code': 200})\nexpected = {'allow_biz_codes': [2000], 'allow_http_codes': [200]}\n\n    def assert_api_response(resp, expected):\n        \"\"\"\n        通用接口断言（最终稳定版）\n        - 以「业务 code」为主\n        - HTTP 状态码只作为兜底\n        - 语义清晰，TG / Allure 友好\n        \"\"\"\n    \n        # =====================================================\n        # 0️⃣ 基础响应信息（永远先记录，防止断言中断）\n        # =====================================================\n        body = _safe_response_body(resp)\n    \n        http_status = getattr(resp, \"status_code\", None)\n        logging.info(f\"[HTTP] status={http_status}\")\n    \n        _attach(\"response_body\", body)\n    \n        biz_json = resp.biz_json or {}\n    \n        # =====================================================\n        # 1️⃣ 业务 code 校验（核心）\n        # =====================================================\n        allow_biz = expected.get(\"allow_biz_codes\")\n    \n        # \uD83D\uDC49 只有在 allow_biz 为「非空列表」时才校验\n        if isinstance(allow_biz, list) and len(allow_biz) > 0:\n            biz_json = resp.biz_json or {}\n            biz_code = _extract_biz_code(biz_json)\n    \n            # 兼容字符串数字\n            if isinstance(biz_code, str) and biz_code.isdigit():\n                biz_code = int(biz_code)\n    \n            logging.info(\n                \"[业务断言] 实际 code=%s | 允许=%s\",\n                biz_code,\n                allow_biz\n            )\n    \n            # 提取 msg（兼容多种字段名）\n            biz_msg = (\n                    biz_json.get(\"msg\")\n                    or biz_json.get(\"message\")\n                    or biz_json.get(\"errorMsg\")\n            )\n            msg_suffix = f\"，msg={biz_msg}\" if biz_msg else \"\"\n    \n            # \uD83D\uDEAB 要求业务 code，但接口没返回\n            if biz_code is None:\n                _attach(\"assert_fail_response\", biz_json)\n                raise AssertionError(\n                    f\"接口未返回业务code\"\n                    f\"，HTTP={resp.status_code}\"\n                    f\"{msg_suffix}\"\n                )\n    \n            try:\n>               assert biz_code in allow_biz, (\n                    f\"接口返回的业务code {biz_code} \"\n                    f\"不在允许范围 {allow_biz} 内\"\n                    f\"{msg_suffix}\"\n                )\nE               AssertionError: 接口返回的业务code 200 不在允许范围 [2000] 内\n\nutils\\assert_util.py:109: AssertionError","steps":[{"name":"/game/games/l_cl","time":{"start":1766564746897,"stop":1766564748945,"duration":2048},"status":"failed","statusMessage":"AssertionError: 接口返回的业务code 200 不在允许范围 [2000] 内\n","statusTrace":"  File \"D:\\PycharmProjects\\23pg-api-test\\tests\\test_08_games.py\", line 40, in test_games\n    biz = assert_api_response(resp, case[\"expected\"])\n  File \"D:\\PycharmProjects\\23pg-api-test\\utils\\assert_util.py\", line 109, in assert_api_response\n    assert biz_code in allow_biz, (\n","steps":[{"name":"检查彩票大厅/长龙链接是否可访问: https://lott.v6a7hash.com/longDragon?token=eyJhbGciOiJIUzUxMiIsImlhdCI6MTc2NjU2NDc0NywiZXhwIjoxNzY2NjUxMTQ3fQ.eyJpZCI6MjY0LCJ1c2VybmFtZSI6InBneWxfcGd5bDM1YTIzMTAwOTU3In0.iIWHz4zxVry9N2Ul8dIkXRXmp2gvR2TwQOsndBOp0nO-NU-i5Z5h6sgm7UjqXO05HeVWFBjuZ8IYuM69UTcIJQ&back_url=extra.dm","time":{"start":1766564748037,"stop":1766564748943,"duration":906},"status":"passed","steps":[],"attachments":[{"uid":"6fd1651135aded1f","name":"彩票大厅/长龙链接验证结果","source":"6fd1651135aded1f.txt","type":"text/plain","size":30}],"parameters":[],"stepsCount":0,"attachmentsCount":1,"shouldDisplayMessage":false,"attachmentStep":false,"hasContent":true}],"attachments":[{"uid":"4ddc5f4211e63596","name":"response_body","source":"4ddc5f4211e63596.json","type":"application/json","size":420},{"uid":"9e8453cc8470ab1d","name":"assert_fail_response","source":"9e8453cc8470ab1d.json","type":"application/json","size":420}],"parameters":[],"stepsCount":1,"attachmentsCount":3,"shouldDisplayMessage":true,"attachmentStep":false,"hasContent":true}],"attachments":[{"uid":"300ad53f5e996783","name":"log","source":"300ad53f5e996783.txt","type":"text/plain","size":2054}],"parameters":[],"stepsCount":2,"attachmentsCount":4,"shouldDisplayMessage":true,"attachmentStep":false,"hasContent":true},"afterStages":[],"labels":[{"name":"feature","value":"游戏模块"},{"name":"tag","value":"smoke"},{"name":"parentSuite","value":"tests"},{"name":"suite","value":"test_08_games"},{"name":"host","value":"DESKTOP-1OGQ5RE"},{"name":"thread","value":"10816-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"tests.test_08_games"},{"name":"resultFormat","value":"allure2"}],"parameters":[{"name":"case","value":"{'desc': '查询长龙链接', 'request': {'method': 'POST', 'url': '/game/games/l', 'check_url_from': {'jsonpath': '$.data.url'}, 'params': {'force_no_encrypt': '567f9c9a-28cf-4096-b540-e428f40a1e74-jh82'}, 'body': {'platform': 'V6Lottery', 'code': 'longDragon', 'currency': 3, 'device': 'h5', 'extra': {'session_token': '${USER_ID}', 'game_type': 'lottery', 'dm': 'https://23pg1.com/#/?isDev=yes&cate_tab=lottery'}}}, 'expected': {'allow_http_codes': [200], 'allow_biz_codes': [2000]}}"},{"name":"case_name","value":"'/game/games/l_cl'"}],"links":[],"hidden":false,"retry":false,"extra":{"severity":"normal","retries":[],"categories":[{"name":"Product defects","matchedStatuses":[]}],"tags":["smoke"]},"source":"7e08de8ea3ce86b0.json","parameterValues":["{'desc': '查询长龙链接', 'request': {'method': 'POST', 'url': '/game/games/l', 'check_url_from': {'jsonpath': '$.data.url'}, 'params': {'force_no_encrypt': '567f9c9a-28cf-4096-b540-e428f40a1e74-jh82'}, 'body': {'platform': 'V6Lottery', 'code': 'longDragon', 'currency': 3, 'device': 'h5', 'extra': {'session_token': '${USER_ID}', 'game_type': 'lottery', 'dm': 'https://23pg1.com/#/?isDev=yes&cate_tab=lottery'}}}, 'expected': {'allow_http_codes': [200], 'allow_biz_codes': [2000]}}","'/game/games/l_cl'"]}