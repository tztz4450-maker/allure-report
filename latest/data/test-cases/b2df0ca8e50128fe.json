{"uid":"b2df0ca8e50128fe","name":"test_user_security[/api/users/i/bind_phone-case1]","fullName":"tests.test_03_user_security#test_user_security","historyId":"d016e0394488250d7c87674861378762","time":{"start":1766646286570,"stop":1766646287134,"duration":564},"status":"failed","statusMessage":"AssertionError: 接口未返回业务code，HTTP=422","statusTrace":"auth_client = <utils.api_client.ApiClient object at 0x000001C73DB8AA70>, case_name = '/api/users/i/bind_phone'\ncase = {'desc': '绑定手机号', 'expected': {'allow_biz_codes': [40000], 'allow_http_codes': [400]}, 'request': {'body': {'country_c...'POST', 'params': {'force_no_encrypt': '567f9c9a-28cf-4096-b540-e428f40a1e74-jh82'}, 'url': '/api/users/i/bind_phone'}}\n\n    @pytest.mark.parametrize(\"case_name, case\", yaml_data.items())\n    @allure.feature(\"用户安全模块\")\n    def test_user_security(auth_client, case_name, case):\n    \n        # 用例标题显示接口名称，而不是 desc\n        with allure.step(case_name):\n    \n            resp = auth_client.request(\n                method=case[\"request\"][\"method\"],\n                url=case[\"request\"][\"url\"],\n                params=case[\"request\"].get(\"params\"),\n                json_body=case[\"request\"].get(\"body\"),\n            )\n    \n            # 核心断言\n>           biz = assert_api_response(resp, case[\"expected\"])\n\ntests\\test_03_user_security.py:26: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\n\nresp = ApiResponse(response=<Response [422]>, raw_text='{\"detail\":[{\"type\":\"string_too_short\",\"loc\":[\"body\",\"phone\"],\"msg\":\"S... 'loc': ['body', 'phone'], 'msg': 'String should have at least 5 characters', 'input': '', 'ctx': {'min_length': 5}}]})\nexpected = {'allow_biz_codes': [40000], 'allow_http_codes': [400]}\n\n    def assert_api_response(resp, expected):\n        \"\"\"\n        通用接口断言（Allure / TG / 日志 友好版）\n    \n        规则：\n        - 业务 code 优先\n        - HTTP 状态码只兜底\n        - 失败只 attach 一次 response_body\n        \"\"\"\n    \n        body = _safe_response_body(resp)\n        biz_json = resp.biz_json or {}\n        http_status = getattr(resp, \"status_code\", None)\n    \n        logging.info(\"[HTTP] status=%s\", http_status)\n    \n        # =====================================================\n        # 1️⃣ 业务 code 校验（核心）\n        # =====================================================\n        allow_biz = expected.get(\"allow_biz_codes\")\n    \n        if isinstance(allow_biz, list) and allow_biz:\n            biz_code = _extract_biz_code(biz_json)\n    \n            if isinstance(biz_code, str) and biz_code.isdigit():\n                biz_code = int(biz_code)\n    \n            biz_msg = _extract_biz_msg(biz_json)\n            msg_suffix = f\"，msg={biz_msg}\" if biz_msg else \"\"\n    \n            logging.info(\n                \"[业务断言] 实际 code=%s | 允许=%s\",\n                biz_code,\n                allow_biz\n            )\n    \n            if biz_code is None:\n                _attach_response(body)\n>               raise AssertionError(\n                    f\"接口未返回业务code，HTTP={http_status}{msg_suffix}\"\n                )\nE               AssertionError: 接口未返回业务code，HTTP=422\n\nutils\\assert_util.py:254: AssertionError","flaky":false,"newFailed":false,"newBroken":false,"newPassed":false,"retriesCount":1,"retriesStatusChange":false,"beforeStages":[{"name":"raw_client","time":{"start":1766646272603,"stop":1766646272604,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"hasContent":false,"attachmentStep":false,"shouldDisplayMessage":false,"attachmentsCount":0,"stepsCount":0},{"name":"pytestconfig","time":{"start":1766646272603,"stop":1766646272603,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"hasContent":false,"attachmentStep":false,"shouldDisplayMessage":false,"attachmentsCount":0,"stepsCount":0},{"name":"auth_client","time":{"start":1766646272604,"stop":1766646274354,"duration":1750},"status":"passed","steps":[],"attachments":[],"parameters":[],"hasContent":false,"attachmentStep":false,"shouldDisplayMessage":false,"attachmentsCount":0,"stepsCount":0},{"name":"auth_guard","time":{"start":1766646286570,"stop":1766646286570,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"hasContent":false,"attachmentStep":false,"shouldDisplayMessage":false,"attachmentsCount":0,"stepsCount":0}],"testStage":{"status":"failed","statusMessage":"AssertionError: 接口未返回业务code，HTTP=422","statusTrace":"auth_client = <utils.api_client.ApiClient object at 0x000001C73DB8AA70>, case_name = '/api/users/i/bind_phone'\ncase = {'desc': '绑定手机号', 'expected': {'allow_biz_codes': [40000], 'allow_http_codes': [400]}, 'request': {'body': {'country_c...'POST', 'params': {'force_no_encrypt': '567f9c9a-28cf-4096-b540-e428f40a1e74-jh82'}, 'url': '/api/users/i/bind_phone'}}\n\n    @pytest.mark.parametrize(\"case_name, case\", yaml_data.items())\n    @allure.feature(\"用户安全模块\")\n    def test_user_security(auth_client, case_name, case):\n    \n        # 用例标题显示接口名称，而不是 desc\n        with allure.step(case_name):\n    \n            resp = auth_client.request(\n                method=case[\"request\"][\"method\"],\n                url=case[\"request\"][\"url\"],\n                params=case[\"request\"].get(\"params\"),\n                json_body=case[\"request\"].get(\"body\"),\n            )\n    \n            # 核心断言\n>           biz = assert_api_response(resp, case[\"expected\"])\n\ntests\\test_03_user_security.py:26: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _\n\nresp = ApiResponse(response=<Response [422]>, raw_text='{\"detail\":[{\"type\":\"string_too_short\",\"loc\":[\"body\",\"phone\"],\"msg\":\"S... 'loc': ['body', 'phone'], 'msg': 'String should have at least 5 characters', 'input': '', 'ctx': {'min_length': 5}}]})\nexpected = {'allow_biz_codes': [40000], 'allow_http_codes': [400]}\n\n    def assert_api_response(resp, expected):\n        \"\"\"\n        通用接口断言（Allure / TG / 日志 友好版）\n    \n        规则：\n        - 业务 code 优先\n        - HTTP 状态码只兜底\n        - 失败只 attach 一次 response_body\n        \"\"\"\n    \n        body = _safe_response_body(resp)\n        biz_json = resp.biz_json or {}\n        http_status = getattr(resp, \"status_code\", None)\n    \n        logging.info(\"[HTTP] status=%s\", http_status)\n    \n        # =====================================================\n        # 1️⃣ 业务 code 校验（核心）\n        # =====================================================\n        allow_biz = expected.get(\"allow_biz_codes\")\n    \n        if isinstance(allow_biz, list) and allow_biz:\n            biz_code = _extract_biz_code(biz_json)\n    \n            if isinstance(biz_code, str) and biz_code.isdigit():\n                biz_code = int(biz_code)\n    \n            biz_msg = _extract_biz_msg(biz_json)\n            msg_suffix = f\"，msg={biz_msg}\" if biz_msg else \"\"\n    \n            logging.info(\n                \"[业务断言] 实际 code=%s | 允许=%s\",\n                biz_code,\n                allow_biz\n            )\n    \n            if biz_code is None:\n                _attach_response(body)\n>               raise AssertionError(\n                    f\"接口未返回业务code，HTTP={http_status}{msg_suffix}\"\n                )\nE               AssertionError: 接口未返回业务code，HTTP=422\n\nutils\\assert_util.py:254: AssertionError","steps":[{"name":"/api/users/i/bind_phone","time":{"start":1766646286570,"stop":1766646287134,"duration":564},"status":"failed","statusMessage":"AssertionError: 接口未返回业务code，HTTP=422\n","statusTrace":"  File \"D:\\PycharmProjects\\23pg-api-test\\tests\\test_03_user_security.py\", line 26, in test_user_security\n    biz = assert_api_response(resp, case[\"expected\"])\n  File \"D:\\PycharmProjects\\23pg-api-test\\utils\\assert_util.py\", line 254, in assert_api_response\n    raise AssertionError(\n","steps":[],"attachments":[{"uid":"cf441a0986a6e6d9","name":"response_body","source":"cf441a0986a6e6d9.json","type":"application/json","size":246}],"parameters":[],"hasContent":true,"attachmentStep":false,"shouldDisplayMessage":true,"attachmentsCount":1,"stepsCount":0}],"attachments":[{"uid":"5f84df35e54e26c6","name":"log","source":"5f84df35e54e26c6.txt","type":"text/plain","size":2609}],"parameters":[],"hasContent":true,"attachmentStep":false,"shouldDisplayMessage":true,"attachmentsCount":2,"stepsCount":1},"afterStages":[],"labels":[{"name":"feature","value":"用户安全模块"},{"name":"parentSuite","value":"tests"},{"name":"suite","value":"test_03_user_security"},{"name":"host","value":"DESKTOP-1OGQ5RE"},{"name":"thread","value":"7116-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"tests.test_03_user_security"},{"name":"resultFormat","value":"allure2"}],"parameters":[{"name":"case","value":"{'desc': '绑定手机号', 'request': {'method': 'POST', 'url': '/api/users/i/bind_phone', 'params': {'force_no_encrypt': '567f9c9a-28cf-4096-b540-e428f40a1e74-jh82'}, 'body': {'country_code': '+86', 'phone': '', 'verify_code': ''}}, 'expected': {'allow_http_codes': [400], 'allow_biz_codes': [40000]}}"},{"name":"case_name","value":"'/api/users/i/bind_phone'"}],"links":[],"hidden":false,"retry":false,"extra":{"severity":"normal","retries":[{"uid":"94fa7280b2ad7fd1","status":"failed","statusDetails":"AssertionError: 接口未返回业务code，HTTP=422","time":{"start":1766646283571,"stop":1766646284483,"duration":912}}],"categories":[{"name":"Product defects","matchedStatuses":[]}],"tags":[]},"source":"b2df0ca8e50128fe.json","parameterValues":["{'desc': '绑定手机号', 'request': {'method': 'POST', 'url': '/api/users/i/bind_phone', 'params': {'force_no_encrypt': '567f9c9a-28cf-4096-b540-e428f40a1e74-jh82'}, 'body': {'country_code': '+86', 'phone': '', 'verify_code': ''}}, 'expected': {'allow_http_codes': [400], 'allow_biz_codes': [40000]}}","'/api/users/i/bind_phone'"]}